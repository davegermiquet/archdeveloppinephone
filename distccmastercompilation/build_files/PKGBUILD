pkgname=Zandronum
pkgver=3.1
pkgrel=1
pkgdesc='Zandronum Doom Like Game'
url=https://github.com/ptitSeb/zandronum
arch=('aarch64')
license=('Sleepycat License')

build() {
   # Cleans Repository
   
   rm -rf zandronum
   git clone https://github.com/ptitSeb/zandronum.git
   
   # Patches code with bug fixes that arent not commited
   
   # stricmp has changedd to strcasecmp
   
   
change_strcasecmp(){
for file_to_change in ./* ; do
if [ ! -d ${1} ] ; then
sed 's/stricmp/strcasecmp/g' ${file_to_change} > ./${file_to_change}.tmp
mv  ${file_to_change}.tmp ${file_to_change}
fi
done
}

   
   # go back to folder for other patches

change_into_folder() {
for folder_in_recursive in ${1}/*
do
if [ -d ${1} ] 
then
cd ${1}
change_into_folder ${folder_in_recursive}
change_strcasecmp
cd ..
fi
done
}

   
   
   change_into_folder src
   
   cp /tmp/setup/GameCompiler.patch  zandronum/game-music-emu/
   cd zandronum/game-music-emu/
   git log
   patch CMakeLists.txt < GameCompiler.patch
   
   # If build is there dont recompile just continue
   
   cd ../../
   
   rm -rf build
   mkdir build
   cd build
   
   # Example PinePhone Compiler Flags for cross compiling and proper settings
   
   export CFLAGS="-march=armv8-a+crypto+crc -mtune=cortex-a53 -fPIC"  
   export CXXFLAGS="-march=armv8-a+crypto+crc -mtune=cortex-a53 -fPIC"
   export NO_ASM=ON
   export NO_FMOD=ON
   export NO_OPENAL=OFF
   
   export DISTCC_HOSTS="192.168.1.183/3 192.168.1.184/3"
   PATH=/usr/lib/distcc:$PATH cmake ../zandronum -DNO_OPENAL=OFF -DCMAKE_BUILD_TYPE=Release -D -DNO_FMOD=ON -DSERVERONLY=OFF -DRELEASE_WITH_DEBUG_FILE=OFF
   
   # Compile with 6 CPUS
   
   make -j6
} 

package() {
   cd build
   make install
}